## 一. 接口定义

与互联网相连的端系统提供了一个应用程序接口(缩写API，又称为应用程序编程接口)是软件系统不同组成部分衔接的约定。-- [维基百科]

上面是在wiki百科中对应用应用程序接口的定义。一开始听到接口这个定义时，我有些迷惑，后来看到这个解释后，就清楚了，API提供了一种约定来与系统不同部分之间衔接，这里的不同的部分可以是APP和服务端之间，也可以是前端和服务端之间，也可以是服务端与服务端之间，而它们之间的通信可以通过HTTP，就是我们常说HTTP接口，也可以通过RPC，就是我们常常说的服务之间远程调用，还可以通过webservice或socket

## 二. 接口的分类

1. HTTP接口
2. RPC远程调用
3. webservice
4. socket

这篇主要介绍HTTP接口如何测试

## 三. 接口测试原理

模拟客户端向服务器发送请求报文，服务器接收请求报文后对相应的报文做处理并向客户端返回应答，客户端再接收应答的一个过程。

## 四. 接口测试范围

接口的功能、性能、安全性。重点关注数据的交换，传递和控制管理过程，还包括处理的次数。

接口测试对象是接口，但随着系统复杂度越来越高，接口越来越多，完全覆盖是一件很困难的事情。通常情况下主要测试最外层的两类接口：数据进入系统的接口（调用外部系统的参数为本系统使用）、数据流出系统接口（验证系统处理后的数据是否正常）

## 五. 接口文档示例

- 接口说明
- 调用的url
- 请求方法（get、post）
- 请求参数，参数类型、请求参数说明
- 返回参数说明
- 返回示例

## 六. API 接口范例

请求网址：

```
http://www.sendcloud.net/smsapi/smsContactList/list
```

返回信息：

```
{"info":{},"message":"smsUser不能为空","result":false,"statusCode":472}
```


## 七. API 测试的基本步骤

1. 准备测试数据（可选步骤）
2. 通过API测试工具，发起对被测数据API的request
3. 验证返回结果response

## 八. 质量评估标准

##### 1. 接口覆盖率是否都达到要求
1) 所有供外部调用的接口必须有相对应的测试用例，覆盖率要达到95%以上。
2) 所有供内部调用并涉及到产品主要功能的接口测试用例覆盖率要达到90%以上。
3) 所有供内部调用并涉及到次要功能的接口，测试代码覆盖率可以随接口复杂度和重要程度增高而增加
##### 2. 测试用例中对接口业务规则的验证是否完整
1) 测试用例要覆盖接口的主要业务规则  
    接口的主要业务规则，就是该接口的主要功能，它影响这接口的业务实现和调用状态。如发布一个宝贝，那么发布一个全新、二手、拍卖、闲置的宝贝等等就是主要功能
2) 测试用例要覆盖接口的常用业务规则  
    还是在发布宝贝的例子，80%的卖家都会在"描述"中加入图片，旺旺链接等，这个业务规则不会影响接口的正常调用。但却影响着用户的使用习惯。所以测试用例中必须包含对"描述字段"中含有图片链接，旺旺链接的验证
3) 参数验证要覆盖对边界值和参数持有业务规则的验证  
    很多接口中都会其参数有一定的限制，如一个字段长度限制为<5，那么就至少要存在对该字段的长度为4，5的测试用例
##### 3. 测试用例中是否覆盖接口之间
如：一个添加口的关联性测试，就要以该添加接口的返回值为参数，来调用其他关联接口如修改和删除接口，验证其是否可调用并且调用成功
##### 4. 遗留的bug对系统的影响程度
1) 经常调用的接口，不可含有主要业务规则和常用业务规则相关的bug，次要业务规则的bug遗留率为0.2以下。
2) 不常调用的接口，不可含有主要业务规则的bug，常用业务规则的bug遗留率为2%以下，次要业务规则的bug遗留率为5%以下
##### 5. 测试用例与测试代码是否一致
##### 6. 测试用例是否可持续回归
##### 7. 经过测试的接口是否达到了调用方的标准，调用方能否使用该接口来开发出产品设计说明书锁设计的应用

## 八. 接口测试常用方式

#### 1. Postman

#### 2. TestNG

#### 3. Springtest

#### 4. 编写脚本

## 九. 如何应对复杂场景的API测试

1. 被测业务操作是由多个API调用协作完成
    - 抓包工具查看调用序列，或者日志
    - API的结果传递给下个API，或根据结果决定调用哪个API
2. API测试过程中的第三方依赖 ，启用mock server来代替真实的API
3. 异步API测试
    - 测试异步调用是否成功:主要检查返回值和后台工作线程（日志查看有没有建立请求，或者看回调结果状态数据库保存）
    - 测试异步调用的业务逻辑处理是否正确
    - 异步api没有callback的接口，循环执行一个查询状态，如果有callback接口，直接回调

## 十. API自动化测试框架

1. Java： OkHttp 和Unitest
2. Python：http.client 和 Requests
3. 基于Rest-Assured封装API测试框架
4. 自己开发的API框架要实现的功能包括：多API顺序调用，API结果传递，API执行前操作和执行后操作，测试数据与代码解耦，集成CI和CD
伪代码示例

![](https://upload-images.jianshu.io/upload_images/2765653-d807d0ce99b323a7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

1) 第1-12行，创建了CreateUserAPI类，包含endpoint，操作方法PUT，lnlineParam和Param的设置并构建了对应的request对象
2) 第14-19行，测试的主体函数
    - 首先，构建CreateUserAPI的对象 
    - 然后，用createUserAPI对象的buildRequest方法结合输入参数构建request对象 
    - 接着，通过request对象的request()方法发起API调用 
    - 最后，验证response中的状态码是不是200
## 十一. 持久化

持续集成是接口实现全面自动化测试的重要技术手段。简单来说，持续集成就是把写好的测试代码持续不断地运行起来，并且利用版本控制技术，让测试代码测试的始终是最新版本的系统接口。并且保证在运行不通过的时候及时定位并解决问题。


## 十二. API测试实例

#### 题目

美团有一个API用于创建团购订单，地址如下： https://open.meituan.com/order/createorder?token=1234567890abcdefghijklmnopqrstuvwxyz 其中，token用于验证用户身份 请求方法：POST 参数类型：application/json

```
参数列表（隐去无关参数）
{
'dealid':90,
'quantity':5
}
传入deal ID(要购买的团购券的ID)和数量后，返回新生成的订单ID(隐去无关参数)。例如：
{
'success':0, //正常情况为0
'msg'：''， //正常情况为空
'orderid'：2910100100, //订单id
}
```

#### 参考答案

考察测试用例设计思路，从功能、性能、安全等多方面思考

#### 功能测试

1. 正向功能，输入合法参数，是否正常的生成订单
2. 参数为空，是否有提示
3. dealid不存在，是否有提示
4. dealid为非数字时的值，是有提示
5. quantity为0或负值，是否有提示
6. quantity大于库存量，是否有提示
7. token无效，是否有提示
8. 入参不是JSON，是否有提示

#### 性能测试

1. 压力测试，考察系统在极限压力下的处理能力
2. 狭义性能测试，验证系统能够达到一定的处理能力
3. 并发测试，测试数据库和应用服务器对并发请求的处理

#### 安全性测试

1. 伪造token攻击
2. 订单潮水攻击
3. deal遍历攻击
4. SQL注入攻击
5. 当同一个用户提交的dealid、quantity相同时，返回的orderID总是一样（没有重复创建订单）



