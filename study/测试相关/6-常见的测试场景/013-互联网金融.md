本文以自己实际参与过的项目介绍业务流程以及测试要点

## 项目背景

为部分符合条件的用户提供一笔消费贷

## 业务结构

![](https://upload-images.jianshu.io/upload_images/2765653-3431e21cee65d26e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

金融系统从业务来讲，主要分为三个部分：贷前、贷中和贷后

1. 贷前主要指：客户获得贷款资格、客户的额度审批、合同签订。
2. 贷中主要指：客户的贷款申请、财务放款。
3. 贷后主要指：贷后还款、回款催收、还款流水、核销等。

但是如果系统足够大，涉及到平台的概念，它又会拆分为各个子系统。每个功能模块就能够形成单个独立小系统，再加上底层平台架构，再增加了很多的子类系统。当前不对此阐述。

业务流程图

![](https://upload-images.jianshu.io/upload_images/2765653-df8360aa1b987079.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


现在依照业务流程梳理功能点：

### 一. 贷前

##### 1. 白名单

1) 定时按照白名单准入规则，筛选出符合条件的用户数据，更新到数据库中
2) 触发到验黑的场景时，将已是白名单的用户更新到黑名单中（状态的变更）
3) 白名单数据同步到电销中心

##### 2. 信审

1) 白名单用户可在h5页面提交信审四要素，四要素包括：身份证、手机号、银行卡、姓名
2) 通过OCR识别身份证信息且不可修改，然后手动填写其他四要素信息
3) 提交四要素信息（此时会进行验四操作，后台逻辑，前端无感知），
4) 验四通过后，进入人脸识别并将获取到的信息保存到表中
5）执行脚本从新网取得征信结果

##### 3. 授信额度

对于信审通过的用户按照授信规则获得授信额度，授信额度就是可以申请借款的最大额度（这个授信额度有最大值，除此之外，如果最终得到的授信额度低于最小借款值，当前申请结果是失败）

### 二. 贷中

##### 1. 提交借款申请
 
1) 提交借款申请，包括借款额度、借款期数、借款类型（等额本息，先息后本）
    - 等额本息：每期还款金额包含利息+本金，且每月还款金额都是一样的（这里的一样并非绝对，可能会相差一些）
    - 先息后本：每期还款金额只有利息，且每月还款金额都是一样的，最后一个还款日还款金额包含当期利息已经全部本金
2) 提交借款后，额度变化，并进行二次人脸识别
3) 人脸识别通过后，开始电子签（电子合同中会包含用户的借款等信息）
4) 电子签通过后，当前提交的借款订单状态变更为待放款

##### 2. 放款

1) 脚本自动轮询表中的状态为待放款的订单，执行放款
    - 先，插入一条放款流水
    - 再，请求放款接口
    - 最后，取得放款结果，更新流水状态和订单状态
    
2) 放款支持手动和自动两种类型，这两者之间的区别是请求放款接口是自动还是手动
3) 放款成功后生成还款计划表，如果放款失败释放额度，可再次申请

### 三. 贷后

1. 借款方式：支持等额本息和先息后本
    - 等额本息：每期还款金额 = 利息 + 本金
    - 先息后本：每期还款金额 = 利息，尾期 = 利息 + 全部本金

2. 还款方式
    - 正常还款：按期还款，就是按照生成的还款计划表到还款日后还款
    - 提前还款：（只支持当期提前还款）等额本息还款金额 = 提前还款利息（年利率/360x全部剩余本金x天数）+ 当期本金；先息后本还款金额=提前还款利息（年利率/360x全部剩余本金x天数）
    - 逾期还款：本月应还本息+逾期金额（本月应还*逾期利率*天数），如果是多期的情况，每期计算后相加
    
3. 总还款计划状态（借款后会生成订单，订单放款成功后，会生成每期还款计划和总的还款计划，这里还款计划状态指的就是总的放款计划）
    - 正常：无逾期且有未还账期
    - 逾期：有逾期未还的账期，还款后且仍有未无逾期账期，状态扭转为正常
    - 结清：全部账期还清
    
4. 订单到期状态（）
    - 已到期：到最后一期还款日
    - 未到期：未到最后一起还款日
    
5. 账期状态
    - 待还款：未到还款日且未还
    - 未结清：已到还款日且未还
    - 已逾期：超过还款期未还
    - 已结清：当期成功还款后    

6. 罚息计算
    - 逾期条件：满足T+3条件后
    - 逾期金额：本月应还*逾期利率*天数
    - 逾期未还，进入催收系统
    
7. 订单还款状态（提交借款申请时提交的订单）
    - 已结清：全部账期还款后
    - 未结清：无逾期且有未还账期
    - 有逾期：有逾期未还的账期，还款后且仍有未无逾期账期，状态扭转为未结清
    - 还款中：当前有正在扣款的账期

8. 扣款方式（）
    - 自动代扣
    - 逾期代扣
    - 主动还款（支持银联和微信）
    - 线下认款  
    
9. 还款流水（每次发起还款时生成一条还款流水，在请求扣款接口，返回扣款结果后，成功则核销账单，执行中是发起扣款没有收到结果期间）
    - 交易结果：成功/失败/执行中
    - 这里涉及到两个概念：资金流/信息流，资金流就是真实的金钱交易，信息流就是伴随真实金钱交易发生的的状态变化

10. 核销列表（实际扣款后才会进行，所以核销只能成功不能失败。如果失败属于异常情况）
    - 核销状态：成功


### 四. 主动还款流程

1) 用户选择某账期发起还款时校验当前账期是否已结清、还款金额是否发生变化、还款状态（是否存在还款中），无则进入主动还款页面，需要带的信息有：订单流水号+还款金额
2) 此时还款流水表会生成一条流水，记录着还款金额以及订单流水号
3) 主动还款页面需要用户的四要素信息以及手机验证码，信息填写完整后发起扣款请求
4) 扣款处理完成会回调接口并返回处理结果，以此来更新还款流水表的交易结果
5）还可以微信支付流程是一样的

其他要注意的问题：

1. 多次产生订单流水号 

每次进入主动还款页面会产生一条还款流水，这条流水最终没有发起支付会在一定有效时间内取消。有的APP设计成在一定时间进入不会生成新的订单流水号，但发起支付后的订单流水号符合支付的幂等性，多次请求结果都是一样。

2. 扣款前后还款计划发生变化，核销如何处理？

核销时还要注意如果恰好卡到产生罚息，可能还扣款前和扣款后的金额不一致的情况，此时要注意核销时要按照还款时间重新计算还款金额并核销，如果有变化更新还款计划

3. 唤起微信支付后，没有支付使用银联支付

主要还款除银联支付外还支持微信还款，微信发起还款后会同样会生成订单流水号，由于微信支持切换到后台所以无法主动取消，只有等微信那边取消回调，这时候会再次回调修改支付结果，要注意的情况是，如果用户唤起了微信但最终使用银联支付成功，此时要注意微信结果回调时，不要修改最终的还款状态

4. 自动代扣期间恰好有用户发起主动还款

无法还款，自动代扣期间为防止并发会对要代扣的订单加锁

### 五. 自动代扣

1) 每天执行脚本过滤出所有符合条件待扣款的账单
2) 在执行发起扣款前进行验证并加锁
3) 验锁通过后判断最近一条支付流水的状态以及还款期数（因为存在有逾期多期未还的情况，这个时候要按期扣款不能发现跳期、重复支付的情况），验证通过后下单并生成还款流水
4) 解锁并发起支付









  














