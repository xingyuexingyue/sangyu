## 扫码支付

#### 二维码简介

- 二维码是用一定规则排布的点阵的图像来编码信息的方式，
- 条码（一维码）

#### 二维码和条码共同特点

1. 容易生成

2. 容易被机器识别

#### 二维码独有的优点：

1. 对变脏和破损的适应能力强

2. 存储大容量信息

3. 可以从任意方向读取

#### 二维码使用场景

1. 身份二维码

2. 收款二维码

3. 付款二维码

#### 身份二维码
  
微信 身份二维码
  
```
http://weixin.qq.com/r/L-rg_G-EbIITrZub0097
```
  
支付宝 身份二维码

```
https://qr.alipay.com/apa2uu7j3tpjyxlr00
```

身份二维码实际上有用的信息就是指定的URL后面的一串号。这个串号具有如下特点：

1. 一直固定不变

2. 无法通过此串号获取用户信息

3. 仅能被自己的app识别其深层含义

4. 这种方式兼顾了隐私性和开放性

#### 收款二维码

UC扫微信和支付宝的收款二维码

微信：

```
https://wx.tenpay.com/f2f?t=AQAAAEBfhXKNRIQUrs6fy4XO8p879
```

支付宝：

```
https://d.alipay.com/i/index.htm?b=RECEIVE_AC&u=mGnPJ/rNBfKKKKKDcQlNGn1mthWAVDa7vw00ow5sM4o=
```

明显看出，换了一个API，同时后面带上一串和用户账号无关串号。此创号具有如下特点：

1. 一直固定不变

2. 无法通过此串号获取用户信息

3. 仅能被自己的app识别其深层含义（自家app查询自家数据库），被客户app扫描后，客户app直接调出向对方账号付款的界面

![](https://upload-images.jianshu.io/upload_images/2765653-0ba457761dc000f4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

1. 商户系统调用支付宝预下单接口alipay.trade.precreate，获得该订单二维码图片地址。

2. 发起轮询获得支付结果：等待5秒后调用交易查询接口alipay.trade.query通过支付时传入的商户订单号(out_trade_no)查询支付结果（返回参数TRADE_STATUS），如果仍然返回等待用户付款（WAIT_BUYER_PAY），则再次等待5秒后继续查询，直到返回确切的支付结果（成功TRADE_SUCCESS 或 已撤销关闭TRADE_CLOSED），或是超出轮询时间。在最后一次查询仍然返回等待用户付款的情况下，必须立即调用交易撤销接口alipay.trade.cancel将这笔交易撤销，避免用户继续支付。

3. 除了主动轮询，也可以通过接受异步通知获得支付结果，详见扫码异步通知，注意一定要对异步通知做验签，确保通知是支付宝发出的。

#### 付款二维码

在付款二维码上，微信和支付宝是差不多的，都是一串每分钟就会变一次的一串数字：

```
284308793673642130

```

此二维码信息具有如下特点：

1. 是一串不带API的数字串

2. 每分钟变一次

3. 通过指定的SDK以此数字为参数进行接口调用可以完成扣款

4. 能且只能被使用一次

其实本质上就是一个付款账号。然后扫码时自动输入这个串号，通过第三方客户端调用支付平台 SDK即可以完成扣款。

此扣款场景及规则如下：支付平台默认只要用户主动出具了二维码，就表示进行了授权扣款。

付款二维码和收款二维码

1. 每分钟必变 和 永久不变

2. 纯参数 和 API + 参数

关于第二点的解释：

app上的扫码所对应的场景众多，必须要做一定的区分，所以带上API名称

条码枪对应的场景单一，仅仅只是扣款，所以二维码只需要对参数进行编码即可

#### 安全风险

关于二维码的风险问题主要从如下几个方面来说：

1. 隐私问题 是否出现用户的私有信息随着二维码的传播而被泄漏，给用户造成困扰

2. 越权问题 是否出现违反用户意图的越权操作问题

#### 隐私问题

在前面对二维码承载的信息分析如此可以看出，用户私有的一些信息：

1. 真实姓名

2. 账号明文

3. 手机号码

都并没有体现在相应的参数当中，黑客很难根据那一串无意义的数据获悉二维码背后的真实的 用户信息。当然，除非黑客攻陷了微信或者支付宝的数据库了，这基本上不太可能。通过这串串号 获取到的用户昵称和头像也仅仅限制在当前app中

#### 越权问题

1. 身份二维码。这个因为单方面加了好友后，是需要二维码身份主人进行验证，所以不存在越权问题

2. 收款二维码。如果有人未经当事人同意"越权"给当事人转账，你会有意见么

3. 付款二维码。有过在超市支付宝付款经历的人肯定知道，掏出手机，亮出二维码，收银员条码枪一过， 一秒过后，钱就被扣走了。如果要说有直接的金钱损失。就是在付款二维码

#### 风险控制

1. 对申请扣款资格主体身份进行严格审核，虽然说不能百分百，但是还是可以极大增加假冒门槛。当然厉害的黑客还是有办法过

2. 设立资金保险。

3. 限额，将这种扣款方式进行限定，将其局限在小额场景。