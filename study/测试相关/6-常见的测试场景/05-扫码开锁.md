## 摩拜扫码开锁过程

#### 共享单车的技术实现，主要包括这几个主要角色：

- 单车上面的智能锁（这个是核心关键，包括了GPS定位模块，GPRS通讯模块，主控芯片，点控锁模块等）

- 用户的手机和APP

- 单车提供商的云服务器（平台）

#### 扫码开锁的过程

1. 单车停当在路边，通过GPS定位模块，定期将定位信息告知给设备商的云服务器

2. 用户通过手机APP，访问云服务器的数据，查看周边的单车停放位置信息。当然，用户自己的位置信息，也授权APP获取了

3. 用户来到单车旁边，扫单车二维码，APP获取单车ID（就是身份编号），发送开锁信息给云服务器，云服务器发送开锁信息给单车 这一步是关键步骤，除了下发开锁指令外，还涉及到用户身份和账户信息核对（是不是交了押金等），单车信息核对（是不是故障车）。

4. 如果一切正常，单车通过GPRS通讯模块收到解锁命令后，就会由主控模块控制车锁进行解锁，用户也会收到解锁成功的信息，并进入计费状态 服务端通过app+GPRS下发开锁指令，app端会有轮询去查询开锁进度，页面给予刷新，呈现相关结果。

5. 用户开始骑行。实时的路径追踪可以使用用户的手机上传位置，单车内的GPS只负责跟踪单车，只需要在一段时间内更新某个点（与跟踪美团外卖员位置类似） ，这个更新时间可以长达30秒到1分钟。

6. 骑行结束。用户手动锁车。单车检测到锁车成功后，发送车已锁好的通知消息给云服务器。云服务器结束计费，发送计费信息和车已锁好的信息给用户APP，用户打开手机APP，可以查看 而车辆锁上后，后台也可以控制延长心跳时间，10到15分钟才更新一次，目前采用AGPS技术也可以在2秒内锁定位置

#### 几种不同开锁方式

- 短信解锁：

    我们可以直接把锁内的 GSM 模块当成是当年的插了SIM卡的黑白功能手机，10秒内的时间，GSM 搜索网络时间没有这么短，更何况在解锁的过程中，我们仅仅是用手机扫码，没有任何激活单车的操作，所以可以肯定锁是始终与网络保持长连接的，就是说这个手机始终是开机的状态，时刻要接收信号。一开始以摩拜为代表的共享单车的开锁过程比现在慢多了，每次开锁大概在6~10秒，但极少开锁失败。笔者很早就注册使用共享单车，对此深有体会。原因其实是最开始的共享单车，开锁并不是使用GPRS流量来控制的，而是服务器通过给自行车发短信（对，就是手机短信），响应然后开锁。6至10秒的延时也正正是短信投递的时间
    
    短信开锁的方式有其优势：开锁比较稳定，开锁不需要通过GPRS/3G流量，比较省电。省电是非常重要的，前期由于共享出行尚未普及，而单车是需要使用者发电维持的（相信大家都知道摩拜初代用的是轴承不是链条，靠我们骑车来发电），如果某辆车一直没人骑，等到它的电量耗尽变成一辆“僵尸车”，一旦这种情况多起来，线下维护的成本就非常高。

- GPRS开锁：

    接下来共享单车开锁方式就直接由服务器通过GPRS/3G流量传达指令开锁。不再担心电量的问题，这种变化是可预见的，因为骑车的人多起来了嘛！通过流量直接开锁，开锁速度也大大提升，从原来靠短信，等待时间有时候要30秒、1分钟（短信收发有时候还不止这么久）变成了3秒内开锁，照顾到很多人的用户体验。但问题随之而来：开锁时间，开锁成功率依赖信号，在信号不强的地区开锁也是十分痛苦的。

- GPRS + 蓝牙开锁：

    我想你们也猜到了，现在的智能锁采用的开锁方式普遍使用的是流量+ 蓝牙辅助开锁，开锁不稳定、开锁时间慢、耗电等所有问题得以一次性解决。蓝牙辅助开锁，原理是使用用户的手机蓝牙通过加密，与锁内的蓝牙配对后开锁。服务器只需用流量连接用户手机，再由手机蓝牙发送开锁指令到智能锁。这样一来，开锁功耗大大降低，也不需要依赖锁中模块的信号强度，提高稳定性。4G手机的流量速度也保证了开锁时间，这种流量蓝牙“二合一”的开锁方式可谓终极方法。